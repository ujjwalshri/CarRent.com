<div ng-init="init()" class="container-fluid">
    <div class="row mb-4">
      <div class="col-md-12">
        <h2 class="text-center mb-4" >Booking History</h2>
  

        <div class="row">
          <div class="col-xs-12">
            <div class="panel panel-default">
              <div class="panel-heading">
                <h3 class="panel-title">Filter and Search</h3>
              </div>
              <div class="panel-body">
                <div class="row">
                  <div class="col-xs-12 col-sm-4 mb-2">
                    <div class="dropdown" uib-dropdown dropdown-append-to-body>
                      <button type="button" class="btn btn-primary btn-block" uib-dropdown-toggle>
                        <span class="glyphicon glyphicon-sort"></span>
                        Sort By: {{selectedSort.label}} <span class="caret"></span>
                      </button>
                      <ul class="dropdown-menu" uib-dropdown-menu>
                        <li><a href ng-click="applySorting('createdAt', -1, 'Latest First')">Latest First</a></li>
                        <li><a href ng-click="applySorting('createdAt', 1, 'Oldest First')">Oldest First</a></li>
                        <li class="divider"></li>
                        <li><a href ng-click="applySorting('amount', -1, 'Amount High to Low')">Amount High to Low</a></li>
                        <li><a href ng-click="applySorting('amount', 1, 'Amount Low to High')">Amount Low to High</a></li>
                      </ul>
                    </div>
                  </div>
    
                  <div class="col-xs-12 col-sm-4 mb-2">
                    <div class="input-group">
                      <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
                      <input type="text" class="form-control" ng-model="search.searchQuery" ng-change="handleSearch()" ng-model-options="{ debounce: 500 }" placeholder="Search by Car Name or Company">
                    </div>
                  </div>
    
                  <div class="col-xs-12 col-sm-4">
                    <button type="button" class="btn btn-default btn-block" ng-click="resetFilters()">
                      <span class="glyphicon glyphicon-refresh"></span> Reset Filters
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  

    <div ng-show="bookings.length > 0 && !isLoading">
      <div class="row">
        <div class="col-xs-12" ng-repeat="booking in bookings">
          <div class="panel">
            <div class="panel-heading">
              <div class="row">
                <div class="col-xs-12 col-sm-8">
                  <h4 class="panel-title" style="margin: 0;">
                    <strong>{{ booking.vehicle.company }} {{ booking.vehicle.name }}</strong>
                    <span class="label" ng-class="{
                    }">{{booking.status | uppercase}}</span>
                  </h4>
                  <small class="text-muted">{{ booking.vehicle.modelYear }} ‚Ä¢ {{ booking.vehicle.fuelType }}</small>
                </div>
                <div class="col-xs-12 col-sm-4 text-right">
                  <h4 style="margin: 5px 0;">{{ booking.amount | currency:"‚Çπ" }}<small>/day</small></h4>
                  <small class="text-muted">Total: {{ booking.calculate() | currency:"‚Çπ" }}</small>
                </div>
              </div>
            </div>
    
            <div class="panel-body">
              <div class="row">
                <div class="col-xs-12 col-sm-6 col-md-3 mb-3">
                  <strong><i class="glyphicon glyphicon-calendar"></i> Rental Period</strong>
                  <div class="text-muted" style="margin-top: 5px;">
                    <small>From:</small> {{booking.startDate | date: 'MMM dd, yyyy'}}<br>
                    <small>To:</small> {{booking.endDate | date: 'MMM dd, yyyy'}}
                  </div>
                </div>
                <div class="col-xs-12 col-sm-6 col-md-3 mb-3">
                  <strong><i class="glyphicon glyphicon-user"></i> Car Owner</strong>
                  <div style="margin-top: 5px;">
                    {{booking.owner.firstName}} {{booking.owner.lastName}}
                    <div class="text-muted"><small>@{{booking.owner.username}}</small></div>
                  </div>
                </div>
                <div class="col-xs-12 col-sm-6 col-md-3 mb-3">
                  <strong><i class="glyphicon glyphicon-info-sign"></i> Vehicle Details</strong>
                  <div class="text-muted" style="margin-top: 5px;">
                    Category: {{booking.vehicle.category}}<br>
                    Fuel Type: {{booking.vehicle.fuelType}}
                  </div>
                </div>
                <div class="col-xs-12 col-sm-6 col-md-3">
                  <div class="btn-group-vertical btn-block">
                    <button class="btn btn-primary btn-sm mb-1" ng-click="booking.generatePDF()">
                      <i class="glyphicon glyphicon-download-alt"></i> Download Invoice
                    </button>
                    <button class="btn btn-info btn-sm mb-1" ng-click="navigateToSingleCarPage(booking.vehicle._id)">
                      <i class="glyphicon glyphicon-repeat"></i> Book Again
                    </button>
                  </div>
                </div>
              </div>


              <div class="row mt-3" ng-if="booking.status === 'ended' && booking.status !== 'reviewed'">
                <div class="col-xs-12">
                  <div class="well">
                    <h4 class="mb-3">Share Your Experience</h4>
                    <form name="reviewForm_{{booking._id}}" ng-submit="addReview(booking)" class="form" novalidate>
                      <div class="form-group">
                        <label>Rating:</label>
                        <div class="star-rating">
                          <span ng-repeat="star in [1, 2, 3, 4, 5]" 
                                ng-click="setRating(star, booking)" 
                                class="star" 
                                ng-class="{'active': star <= booking.review.rating}">
                              ‚òÖ
                          </span>
                        </div>
                        <input type="hidden" name="rating" ng-model="booking.review.rating" required>
                        <p class="text-muted" ng-show="booking.review.rating">You selected: {{booking.review.rating}} star<span ng-if="booking.review.rating > 1">s</span></p>
                        <p class="text-danger" ng-show="reviewForm_{{booking._id}}.$submitted && !booking.review.rating">
                          Please select a rating.
                        </p>
                      </div>

                      <div class="form-group">
                        <label>Review:</label>
                        <textarea name="newReview" class="form-control" ng-model="booking.review.newReview" rows="3" 
                          ng-maxlength="150" placeholder="Share your experience with this car..."></textarea>
                        <p class="text-danger" ng-show="reviewForm_{{booking._id}}.newReview.$error.maxlength">
                          Review cannot be more than 150 characters.
                        </p>
                      </div>

                      <button type="submit" class="btn btn-success" ng-disabled="reviewForm_{{booking._id}}.$invalid || isLoading">
                        <i class="glyphicon glyphicon-ok"></i> Submit Review
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  

    <div class="row" ng-hide="bookings.length > 0">
      <div class="col-md-6 col-md-offset-3">
        <div class="well text-center">
          <h1>üóìÔ∏è</h1>
          <h2 class="text-muted">No Booking History</h2>
        </div>
      </div>
    </div>

    <script type="text/ng-template" id="reviewModal.html">
        <div class="modal-header">
            <button type="button" class="close" ng-click="close()" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            <h4 class="modal-title">Review Your Booking</h4>
        </div>
        <div class="modal-body">
            <div class="well well-sm">
                <h4>{{booking.vehicle.company}} {{booking.vehicle.name}}</h4>
            </div>

            <form name="reviewForm" ng-submit="addReview()" class="form-horizontal" novalidate>
                <div class="form-group" ng-class="{'has-error': reviewForm.rating.$touched && reviewForm.rating.$invalid}">
                    <label class="col-sm-3 control-label">Rating:</label>
                    <div class="col-sm-9">
                        <div class="star-rating">
                            <span ng-repeat="star in [1, 2, 3, 4, 5]" 
                                  ng-click="setRating(star)" 
                                  class="star" 
                                  ng-class="{'active': star <= review.rating}">
                                ‚òÖ
                            </span>
                        </div>
                        <input type="hidden" name="rating" ng-model="review.rating" required>
                        <p class="text-muted" ng-show="review.rating">You selected: {{review.rating}} star<span ng-if="review.rating > 1">s</span></p>
                        <p class="text-danger" ng-show="reviewForm.$submitted && !review.rating">
                            Please select a rating.
                        </p>
                    </div>
                </div>

                <div class="form-group" ng-class="{'has-error': reviewForm.newReview.$touched && reviewForm.newReview.$invalid}">
                    <label class="col-sm-3 control-label">Review:</label>
                    <div class="col-sm-9">
                        <textarea name="newReview" class="form-control" ng-model="review.newReview" rows="4" 
                            ng-maxlength="150" placeholder="Share your experience with this car..."></textarea>
                        <p class="text-danger" ng-show="reviewForm.newReview.$error.maxlength">
                            Review cannot be more than 150 characters.
                        </p>
                    </div>
                </div>

                <div class="form-group">
                    <div class="col-sm-offset-3 col-sm-9">
                        <button type="submit" class="btn btn-success btn-block" ng-disabled="reviewForm.$invalid || isLoading">
                            <i class="glyphicon glyphicon-ok"></i> Submit Review
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </script>
  

    <div class="text-center" ng-show="isLoading">
      <i class="fa fa-spinner fa-spin fa-3x fa-fw text-primary"></i>
      <span class="text-primary">Loading...</span>
    </div>
  

    <div class="text-center" ng-if="pagination.totalItems > 0">
      <ul uib-pagination
          total-items="pagination.totalItems"
          ng-model="pagination.currentPage"
          max-size="pagination.maxSize"
          class="pagination-sm"
          boundary-links="true"
          force-ellipses="true"
          items-per-page="pagination.itemsPerPage"
          ng-change="pageChanged()"
          first-text="&laquo;"
          last-text="&raquo;"
          previous-text="&lsaquo;"
          next-text="&rsaquo;"
          direction-links="true"
          rotate="true">
      </ul>
    </div>
  </div>
</div>

<style>

    .star-rating {
        font-size: 24px;
        display: inline-block;
        cursor: pointer;
        margin-bottom: 10px;
    }
    
    .star-rating .star {
        color: #ccc;
        display: inline-block;
        padding: 0 2px;
        transition: color 0.2s ease;
    }
    
    .star-rating .star:hover,
    .star-rating .star.active {
        color: #FFD700;
    }
    

    .star-rating .star:hover ~ .star {
        color: #ccc;
    }
    
    .star-rating .star:hover ~ .star.active {
        color: #FFD700;
    }

    .mb-1 { margin-bottom: 8px; }
    .mb-2 { margin-bottom: 16px; }
    .mb-3 { margin-bottom: 24px; }
    @media (max-width: 767px) {
      .panel-heading .text-right {
        text-align: left;
        margin-top: 10px;
      }
      .btn-group-vertical {
        margin-top: 15px;
      }
      .panel-body {
        padding: 10px;
      }
    }
</style>