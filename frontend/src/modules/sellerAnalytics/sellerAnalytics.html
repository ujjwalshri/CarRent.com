<back-button></back-button>
<div class="container-fluid" ng-init="init()" ng-class="{'blur-content': isLoading}">
    <div class="page-header">
        <h1><i class="glyphicon glyphicon-stats"></i> Seller Analytics Dashboard</h1>
    </div>

    <uib-alert type="info" class="mb-3">
        <div class="row">
            <div class="col-xs-12 col-sm-6 col-lg-5">
                <div class="form-group">
                    <label class="control-label">
                        <i class="glyphicon glyphicon-calendar"></i> Start Date
                    </label>
                    <input type="date" class="form-control" ng-model="startDate" placeholder="Select start date">
                </div>
            </div>
            <div class="col-xs-12 col-sm-6 col-lg-5">
                <div class="form-group">
                    <label class="control-label">
                        <i class="glyphicon glyphicon-calendar"></i> End Date
                    </label>
                    <input type="date" class="form-control" ng-model="endDate" placeholder="Select end date">
                </div>
            </div>
            <div class="col-xs-12 col-lg-2">
                <div class="form-group">
                    <label class="control-label">&nbsp;</label>
                    <div class="btn-group btn-block">
                        <button class="btn btn-primary" ng-click="getAnalytics()">
                            <i class="glyphicon glyphicon-refresh"></i> Apply
                        </button>
                        <button class="btn btn-default" ng-click="resetDateFilter()">
                            <i class="glyphicon glyphicon-repeat"></i> Reset
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </uib-alert>

    <uib-alert type="info" ng-if="startDate && endDate">
        Showing analytics from <strong>{{startDate | date:'MMM d, yyyy'}}</strong> to <strong>{{endDate | date:'MMM d, yyyy'}}</strong>
    </uib-alert>
    <uib-tabset>
        <uib-tab heading="Performance Analytics" select="onTabSelect('performance')" active="true">
            <loading-component is-loading="isPerformanceLoading" loading-text="Loading performance analytics..."></loading-component>

            <div ng-if="!isPerformanceLoading && performanceLoaded">
                <div class="row">
                    <div class="col-xs-12 col-sm-6 col-md-4 col-lg-2" ng-repeat="metric in [
                        { icon: 'glyphicon glyphicon-usd', title: 'Total Revenue', value: totalRevenue, desc: 'total revenue generated by your cars', panel: 'primary' },
                        { icon: 'glyphicon glyphicon-calendar', title: 'Total no. of bookings', value: numberOfBookings, desc: 'bookings in the selected date range', panel: 'primary' },
                        { icon: 'glyphicon glyphicon-star', title: 'Negative Reviews', value: negativeReviewsCount, desc: 'Based on ratings below 3 stars', panel: 'warning' },
                        { icon: 'glyphicon glyphicon-list-alt', title: 'Extra Travel Charges', value: totalFineCollected, desc: 'total fine collected by your cars', panel: 'success' },
                        { icon: 'glyphicon glyphicon-list-alt', title: 'Addons revenue', value: totalRevenueByAddons, desc: 'total revenue by your addons', panel: 'success' },
                        { icon: 'glyphicon glyphicon-list-alt', title: 'Average bid cost', value: averageBidCostPerRental, desc: 'average bid cost per rental', panel: 'success' }
                    ]">
                        <div class="panel panel-{{metric.panel}}">
                            <div class="panel-heading">
                                <i class="{{metric.icon}}"></i> {{metric.title}}
                            </div>
                            <div class="panel-body text-center">
                                <h3 ng-if="metric.title === 'Total no. of bookings'">{{metric.value }}</h3>
                                <h3 ng-if="metric.title !== 'Total no. of bookings' && metric.title !== 'Negative Reviews'">{{metric.value | currency:'₹':2}}</h3>
                                <h3 ng-if="metric.title === 'Negative Reviews'">{{metric.value}}</h3>
                                <p class="text-success" ng-if="metric.title !== 'Negative Reviews'">
                                    <i class="glyphicon glyphicon-stats"></i> {{metric.desc}}
                                </p>
                                <p ng-if="metric.title === 'Negative Reviews'"><small>{{metric.desc}}</small></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-xs-12 col-md-4" ng-repeat="chart in [
                        { title: 'Most Popular Cars', id: 'myMostPopularCar', chartType: 'bar' },
                        { title: 'Car Categories (Pie)', id: 'carCategoriesPieChart', chartType: 'pie' },
                        { title: 'Car Wise Negative Reviews (ratings less than 3)', id: 'carWiseNegativeReviews', chartType: 'bar' },
                        { title: 'Top 3 Cars by Earnings', id: 'top3CarsWithMostEarning', chartType: 'bar' },
                        { title: 'Top City Wise Negative Reviews(ratings less than 3)', id: 'cityWiseNegativeReviews', chartType: 'line' },
                        { title: 'Top City Wise earnings', id: 'cityWiseEarnings', chartType: 'bar' },
                    ]">
                        <div class="panel panel-default">
                            <div class="panel-heading">{{chart.title}}</div>
                            <div class="panel-body">
                                <canvas id="{{chart.id}}" width="400" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </uib-tab>

        <uib-tab heading="Booking Analytics" select="onTabSelect('booking')">
            <loading-component is-loading="isBookingLoading" loading-text="Loading booking analytics..."></loading-component>

            <div ng-if="!isBookingLoading && bookingLoaded">
                <div class="row">
                    <div class="col-xs-12 col-md-4">
                        <div class="panel panel-info">
                            <div class="panel-heading">
                                <i class="glyphicon glyphicon-time"></i> Average Rental Duration
                            </div>
                            <div class="panel-body text-center">
                                <h3>{{averageRentalDuration.toFixed(2)}} days</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-12 col-md-4">
                        <div class="panel panel-success">
                            <div class="panel-heading">
                                <i class="glyphicon glyphicon-repeat"></i> Repeating Customers
                            </div>
                            <div class="panel-body text-center">
                                <h3>{{repeatingCustomersPercentage.toFixed(2)}}%</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-12 col-md-4">
                        <div class="panel panel-success">
                            <div class="panel-heading">
                                <i class="glyphicon glyphicon-usd"></i> Average Booking Payment
                            </div>
                            <div class="panel-body text-center">
                                <h3>{{averageBookingPayment | currency:'₹':2}}</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-xs-12 col-md-4" ng-repeat="chart in [
                        { title: 'Peak Bidding Hours', id: 'hourlyBiddingHeatmap', chartType: 'line' },
                        { title: 'Monthly Bookings', id: 'numberOfBookingsPerMonth', chartType: 'bar' },
                        { title: 'City-wise Bookings', id: 'cityWiseBooking', chartType: 'bar' },
                        { title: 'Top 3 Customers', id: 'top3CostumersWithMostBookings', chartType: 'bar' },
                        { title: 'Biddings comparison', id: 'myBidsVsOtherSellersAvgBids', chartType: 'line' },
                        { title: 'Earning comparison', id: 'myEarningVsOtherSellersAvgEarnings', chartType: 'line' },
                        { title: 'Addons Distribution (Pie)', id: 'addonsPieChart', chartType: 'pie' },
                    ]">
                        <div class="panel panel-default">
                            <div class="panel-heading">{{chart.title}}</div>
                            <div class="panel-body">
                                <canvas id="{{chart.id}}" width="400" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </uib-tab>

        <uib-tab heading="AI Insights On Your Reviews" select="onTabSelect('aiInsights')">
            <loading-component is-loading="isAiInsightsLoading" loading-text="Loading AI-powered insights..."></loading-component>
            
            <div ng-if="!isAiInsightsLoading && aiInsightsLoaded">
                <div class="row">
                    <div class="col-xs-12">
                        <div class="panel panel-primary">
                            <div class="panel-heading">
                                <h3 class="panel-title"><i class="glyphicon glyphicon-education"></i> AI-Powered Review Analysis</h3>
                            </div>
                            <div class="panel-body">
                                <div class="alert alert-info" ng-if="!reviewInsights">
                                    <i class="glyphicon glyphicon-info-sign"></i> Select a date range and click "Apply" to generate AI insights from your customer reviews.
                                </div>
                                
                                <div ng-if="reviewInsights">
                                    <div class="row">
                                        <div class="col-xs-12 col-md-4">
                                            <div class="panel panel-default">
                                                <div class="panel-heading"><i class="glyphicon glyphicon-stats"></i> Review Stats</div>
                                                <div class="panel-body">
                                                    <p><strong>Total Reviews:</strong> {{reviewInsights.totalReviews}}</p>
                                                    <p><strong>Average Rating:</strong> {{reviewInsights.averageRating}} / 5</p>
                                                    <p><strong>Positive Reviews:</strong> {{reviewInsights.reviewDistribution.positive}}</p>
                                                    <p><strong>Neutral Reviews:</strong> {{reviewInsights.reviewDistribution.neutral}}</p>
                                                    <p><strong>Negative Reviews:</strong> {{reviewInsights.reviewDistribution.negative}}</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-xs-12 col-md-8">
                                            <div class="panel panel-default">
                                                <div class="panel-heading"><i class="glyphicon glyphicon-flash"></i> Executive Summary</div>
                                                <div class="panel-body">
                                                    <p>{{reviewInsights.analysis.summary}}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-xs-12 col-sm-6">
                                            <div class="panel panel-success">
                                                <div class="panel-heading"><i class="glyphicon glyphicon-thumbs-up"></i> Your Strengths</div>
                                                <div class="panel-body">
                                                    <ul>
                                                        <li ng-repeat="strength in reviewInsights.analysis.strengths">{{strength}}</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-xs-12 col-sm-6">
                                            <div class="panel panel-warning">
                                                <div class="panel-heading"><i class="glyphicon glyphicon-wrench"></i> Areas for Improvement</div>
                                                <div class="panel-body">
                                                    <ul>
                                                        <li ng-repeat="area in reviewInsights.analysis.improvementAreas">{{area}}</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-xs-12 col-sm-6">
                                            <div class="panel panel-info">
                                                <div class="panel-heading"><i class="glyphicon glyphicon-road"></i> Vehicle Insights</div>
                                                <div class="panel-body">
                                                    <p>{{reviewInsights.analysis.vehicleInsights}}</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-xs-12 col-sm-6">
                                            <div class="panel panel-info">
                                                <div class="panel-heading"><i class="glyphicon glyphicon-map-marker"></i> Geographical Insights</div>
                                                <div class="panel-body">
                                                    <p>{{reviewInsights.analysis.geographicalInsights}}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-xs-12 col-sm-6">
                                            <div class="panel panel-primary">
                                                <div class="panel-heading"><i class="glyphicon glyphicon-list"></i> Actionable Recommendations</div>
                                                <div class="panel-body">
                                                    <ol>
                                                        <li ng-repeat="recommendation in reviewInsights.analysis.recommendations">{{recommendation}}</li>
                                                    </ol>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-xs-12 col-sm-6">
                                            <div class="panel panel-info">
                                                <div class="panel-heading"><i class="glyphicon glyphicon-signal"></i> Trends</div>
                                                <div class="panel-body">
                                                    <p>{{reviewInsights.analysis.trends}}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row" ng-if="reviewInsights.reviews.length > 0">
                                        <div class="col-xs-12">
                                            <div class="panel panel-default">
                                                <div class="panel-heading"><i class="glyphicon glyphicon-comment"></i> Recent Reviews (Sample)</div>
                                                <div class="panel-body">
                                                    <div class="review-item" ng-repeat="review in reviewInsights.reviews">
                                                        <div class="media">
                                                            <div class="media-left">
                                                                <span class="badge" ng-class="{
                                                                    'badge-success': review.rating >= 4,
                                                                    'badge-warning': review.rating == 3,
                                                                    'badge-danger': review.rating < 3
                                                                }">{{review.rating}}/5</span>
                                                            </div>
                                                            <div class="media-body">
                                                                <h5 class="media-heading">
                                                                    <strong>{{review.vehicle.company}} {{review.vehicle.name}}</strong>
                                                                    <small class="text-muted">{{review.createdAt | date:'MMM d, yyyy'}}</small>
                                                                </h5>
                                                                <p>{{review.review}}</p>
                                                                <small class="text-muted">
                                                                    <i class="glyphicon glyphicon-map-marker"></i> {{review.vehicle.city}}
                                                                    <i class="glyphicon glyphicon-tag"></i> {{review.vehicle.category}}
                                                                </small>
                                                            </div>
                                                        </div>
                                                        <hr ng-if="!$last">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </uib-tab>
    </uib-tabset>
</div>
