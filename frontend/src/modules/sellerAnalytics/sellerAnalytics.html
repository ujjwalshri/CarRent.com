<back-button></back-button>
<div class="container-fluid" ng-init="init()" ng-class="{'blur-content': isLoading}">
    <div class="page-header">
        <h1><i class="glyphicon glyphicon-stats"></i> Seller Analytics Dashboard</h1>
    </div>

    <uib-alert type="info" class="mb-3">
        <div class="row">
            <div class="col-xs-12 col-sm-6 col-lg-5">
                <div class="form-group">
                    <label class="control-label">
                        <i class="glyphicon glyphicon-calendar"></i> Start Date
                    </label>
                    <input type="date" class="form-control" ng-model="startDate" placeholder="Select start date">
                </div>
            </div>
            <div class="col-xs-12 col-sm-6 col-lg-5">
                <div class="form-group">
                    <label class="control-label">
                        <i class="glyphicon glyphicon-calendar"></i> End Date
                    </label>
                    <input type="date" class="form-control" ng-model="endDate" placeholder="Select end date">
                </div>
            </div>
            <div class="col-xs-12 col-lg-2">
                <div class="form-group">
                    <label class="control-label">&nbsp;</label>
                    <div class="btn-group btn-block">
                        <button class="btn btn-primary" ng-click="getAnalytics()">
                            <i class="glyphicon glyphicon-refresh"></i> Apply
                        </button>
                        <button class="btn btn-default" ng-click="resetDateFilter()">
                            <i class="glyphicon glyphicon-repeat"></i> Reset
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </uib-alert>

    <uib-alert type="info" ng-if="startDate && endDate">
        Showing analytics from <strong>{{startDate | date:'MMM d, yyyy'}}</strong> to <strong>{{endDate | date:'MMM d, yyyy'}}</strong>
    </uib-alert>
    <uib-tabset>
        <uib-tab heading="Performance Analytics" select="onTabSelect('performance')" active="true">
            <loading-component is-loading="isPerformanceLoading" loading-text="Loading performance analytics..."></loading-component>

            <div ng-if="!isPerformanceLoading && performanceLoaded">
                <div class="row">
                    <div class="col-xs-12 col-sm-6 col-md-4 col-lg-2" ng-repeat="metric in [
                        { icon: 'glyphicon glyphicon-usd', title: 'Total Revenue', value: totalRevenue, desc: 'total revenue generated by your cars', panel: 'primary' },
                        { icon: 'glyphicon glyphicon-calendar', title: 'Total no. of bookings', value: numberOfBookings, desc: 'bookings in the selected date range', panel: 'primary' },
                        { icon: 'glyphicon glyphicon-star', title: 'Negative Reviews', value: negativeReviewsCount, desc: 'Based on ratings below 3 stars', panel: 'warning' },
                        { icon: 'glyphicon glyphicon-list-alt', title: 'Extra Travel Charges', value: totalFineCollected, desc: 'total fine collected by your cars', panel: 'success' },
                        { icon: 'glyphicon glyphicon-list-alt', title: 'Addons revenue', value: totalRevenueByAddons, desc: 'total revenue by your addons', panel: 'success' },
                        { icon: 'glyphicon glyphicon-list-alt', title: 'Average bid cost', value: averageBidCostPerRental, desc: 'average bid cost per rental', panel: 'success' }
                    ]">
                        <div class="panel panel-{{metric.panel}}">
                            <div class="panel-heading">
                                <i class="{{metric.icon}}"></i> {{metric.title}}
                            </div>
                            <div class="panel-body text-center">
                                <h3 ng-if="metric.title === 'Total no. of bookings'">{{metric.value }}</h3>
                                <h3 ng-if="metric.title !== 'Total no. of bookings' && metric.title !== 'Negative Reviews'">{{metric.value | currency:'₹':2}}</h3>
                                <h3 ng-if="metric.title === 'Negative Reviews'">{{metric.value}}</h3>
                                <p class="text-success" ng-if="metric.title !== 'Negative Reviews'">
                                    <i class="glyphicon glyphicon-stats"></i> {{metric.desc}}
                                </p>
                                <p ng-if="metric.title === 'Negative Reviews'"><small>{{metric.desc}}</small></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-xs-12 col-md-4" ng-repeat="chart in [
                    { title: 'Car Categories (Pie)', id: 'carCategoriesPieChart', chartType: 'pie' },
                     { title: 'Top City Wise earnings', id: 'cityWiseEarnings', chartType: 'bar' },
                    { title: 'Top City Wise Negative Reviews(ratings less than 3)', id: 'cityWiseNegativeReviews', chartType: 'line' },
                        { title: 'Most Popular Cars', id: 'myMostPopularCar', chartType: 'bar' },
                        { title: 'Car Wise Negative Reviews (ratings less than 3)', id: 'carWiseNegativeReviews', chartType: 'bar' },
                        { title: 'Top 3 Cars by Earnings', id: 'top3CarsWithMostEarning', chartType: 'bar' },
                    ]">
                        <div class="panel panel-default">
                            <div class="panel-heading">{{chart.title}}</div>
                            <div class="panel-body">
                                <canvas id="{{chart.id}}" width="400" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </uib-tab>

        <uib-tab heading="Booking Analytics" select="onTabSelect('booking')">
            <loading-component is-loading="isBookingLoading" loading-text="Loading booking analytics..."></loading-component>

            <div ng-if="!isBookingLoading && bookingLoaded">
                <div class="row">
                    <div class="col-xs-12 col-md-4">
                        <div class="panel panel-info">
                            <div class="panel-heading">
                                <i class="glyphicon glyphicon-time"></i> Average Rental Duration
                            </div>
                            <div class="panel-body text-center">
                                <h3>{{averageRentalDuration.toFixed(2)}} days</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-12 col-md-4">
                        <div class="panel panel-success">
                            <div class="panel-heading">
                                <i class="glyphicon glyphicon-repeat"></i> Repeating Customers
                            </div>
                            <div class="panel-body text-center">
                                <h3>{{repeatingCustomersPercentage.toFixed(2)}}%</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-12 col-md-4">
                        <div class="panel panel-success">
                            <div class="panel-heading">
                                <i class="glyphicon glyphicon-usd"></i> Average Booking Payment
                            </div>
                            <div class="panel-body text-center">
                                <h3>{{averageBookingPayment | currency:'₹':2}}</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-xs-12 col-md-4" ng-repeat="chart in [
                        { title: 'Peak Bidding Hours', id: 'hourlyBiddingHeatmap', chartType: 'line' },
                        { title: 'Monthly Bookings', id: 'numberOfBookingsPerMonth', chartType: 'bar' },
                        { title: 'City-wise Bookings', id: 'cityWiseBooking', chartType: 'bar' },
                        { title: 'Top 3 Customers', id: 'top3CostumersWithMostBookings', chartType: 'bar' },
                        { title: 'Biddings comparison', id: 'myBidsVsOtherSellersAvgBids', chartType: 'line' },
                        { title: 'Earning comparison', id: 'myEarningVsOtherSellersAvgEarnings', chartType: 'line' },
                        { title: 'Addons Distribution (Pie)', id: 'addonsPieChart', chartType: 'pie' },
                    ]">
                        <div class="panel panel-default">
                            <div class="panel-heading">{{chart.title}}</div>
                            <div class="panel-body">
                                <canvas id="{{chart.id}}" width="400" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </uib-tab>

        <uib-tab heading="AI Insights On Your Reviews" select="onTabSelect('aiInsights')">
            <div class="container-fluid">
                <!-- Loading indicator -->
                <loading-component is-loading="isAiInsightsLoading" loading-text="Loading AI-powered insights..."></loading-component>
                
                <!-- No insights message -->
                <div ng-if="!isAiInsightsLoading && aiInsightsLoaded && !reviewInsights" class="alert alert-info">
                    <i class="glyphicon glyphicon-info-sign"></i> Select a date range and click "Apply" to generate AI insights from your customer reviews.
                </div>
                
                <!-- AI Insights Content -->
                <div ng-if="!isAiInsightsLoading && aiInsightsLoaded && reviewInsights">
                    <!-- Header Panel -->
                    <div class="panel panel-primary">
                        <div class="panel-heading">
                            <div class="row">
                                <div class="col-xs-6">
                                    <h4><i class="glyphicon glyphicon-education"></i> AI Review Analysis</h4>
                                </div>
                                <div class="col-xs-6 text-right">
                                    <span class="label label-default">{{reviewInsights.totalReviews}} Reviews</span>
                                    <span class="label label-xinfo">{{reviewInsights.averageRating}}/5 Avg</span>
                                </div>
                            </div>
                        </div>
                        <div class="panel-body">
                            <!-- Review Distribution -->
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="well well-sm">
                                        <div class="row">
                                            <div class="col-xs-12">
                                                <h5 class="text-center"><strong>Review Distribution</strong></h5>
                                                <div class="progress">
                                                    <div class="progress-bar progress-bar-success" ng-style="{'width': (reviewInsights.reviewDistribution.positive / reviewInsights.totalReviews * 100) + '%'}">
                                                        {{reviewInsights.reviewDistribution.positive}} Positive
                                                    </div>
                                                    <div class="progress-bar progress-bar-warning" ng-style="{'width': (reviewInsights.reviewDistribution.neutral / reviewInsights.totalReviews * 100) + '%'}">
                                                        {{reviewInsights.reviewDistribution.neutral}} Neutral
                                                    </div>
                                                    <div class="progress-bar progress-bar-danger" ng-style="{'width': (reviewInsights.reviewDistribution.negative / reviewInsights.totalReviews * 100) + '%'}">
                                                        {{reviewInsights.reviewDistribution.negative}} Negative
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <blockquote>
                                        <p><small>{{reviewInsights.analysis.summary}}</small></p>
                                    </blockquote>
                                </div>
                            </div>
                            
                            <!-- Insights Collapsible Panels -->
                            <uib-accordion close-others="false">
                                <!-- Strengths & Areas for Improvement -->
                                <div uib-accordion-group class="panel-success" heading="Strengths & Areas for Improvement">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="panel panel-success">
                                                <div class="panel-heading">
                                                    <i class="glyphicon glyphicon-thumbs-up"></i> Key Strengths
                                                </div>
                                                <ul class="list-group">
                                                    <li class="list-group-item" ng-repeat="strength in reviewInsights.analysis.strengths | limitTo:3">
                                                        {{strength}}
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="panel panel-warning">
                                                <div class="panel-heading">
                                                    <i class="glyphicon glyphicon-wrench"></i> Improvement Areas
                                                </div>
                                                <ul class="list-group">
                                                    <li class="list-group-item" ng-repeat="area in reviewInsights.analysis.improvementAreas | limitTo:3">
                                                        {{area}}
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Detailed Insights -->
                                <div uib-accordion-group class="panel-info">
                                    <uib-accordion-heading>
                                        <i class="glyphicon glyphicon-dashboard"></i> Detailed Insights
                                    </uib-accordion-heading>
                                    <uib-tabset>
                                        <uib-tab heading="Vehicle">
                                            <p>{{reviewInsights.analysis.vehicleInsights}}</p>
                                        </uib-tab>
                                        <uib-tab heading="Geographical">
                                            <p>{{reviewInsights.analysis.geographicalInsights}}</p>
                                        </uib-tab>
                                        <uib-tab heading="Trends">
                                            <p>{{reviewInsights.analysis.trends}}</p>
                                        </uib-tab>
                                    </uib-tabset>
                                </div>
                                
                                <!-- Actionable Recommendations -->
                                <div uib-accordion-group class="panel-primary">
                                    <uib-accordion-heading>
                                        <i class="glyphicon glyphicon-list-alt"></i> Actionable Recommendations
                                    </uib-accordion-heading>
                                    <ol>
                                        <li ng-repeat="recommendation in reviewInsights.analysis.recommendations">
                                            {{recommendation}}
                                        </li>
                                    </ol>
                                </div>
                                
                                <!-- Sample Reviews -->
                                <div uib-accordion-group class="panel-default" ng-if="reviewInsights.reviews.length > 0">
                                    <uib-accordion-heading>
                                        <i class="glyphicon glyphicon-comment"></i> Sample Reviews 
                                        <span class="badge">{{reviewInsights.reviews.length}}</span>
                                    </uib-accordion-heading>
                                    <div class="list-group">
                                        <div class="list-group-item" ng-repeat="review in reviewInsights.reviews">
                                            <div class="row">
                                                <div class="col-xs-1">
                                                    <span class="badge" ng-class="{
                                                        'alert-success': review.rating >= 4,
                                                        'alert-warning': review.rating == 3,
                                                        'alert-danger': review.rating < 3
                                                    }">{{review.rating}}</span>
                                                </div>
                                                <div class="col-xs-11">
                                                    <div class="pull-right text-muted">
                                                        <small>{{review.createdAt | date:'MMM d, yyyy'}}</small>
                                                    </div>
                                                    <h5 class="list-group-item-heading">
                                                        {{review.vehicle.company}} {{review.vehicle.name}}
                                                    </h5>
                                                    <p class="list-group-item-text">{{review.review}}</p>
                                                    <div class="text-muted">
                                                        <small>
                                                            <i class="glyphicon glyphicon-map-marker"></i> {{review.vehicle.city}} 
                                                            <i class="glyphicon glyphicon-tag"></i> {{review.vehicle.category}}
                                                        </small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </uib-accordion>
                        </div>
                        <div class="panel-footer text-right text-muted">
                            <small><i class="glyphicon glyphicon-info-sign"></i> Generated using AI analysis of customer feedback</small>
                        </div>
                    </div>
                </div>
            </div>
        </uib-tab>
    </uib-tabset>
</div>
