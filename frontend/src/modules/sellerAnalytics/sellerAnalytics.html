<back-button></back-button>
<div class="container-fluid" ng-init="init()" ng-class="{'blur-content': isLoading}">
    <div class="page-header">
        <h1><i class="fas fa-chart-line"></i> Seller Analytics Dashboard</h1>
    </div>

    <uib-alert type="info" class="mb-3">
        <div class="row">
            <div class="col-xs-12 col-sm-6 col-lg-5">
                <div class="form-group">
                    <label class="control-label">
                        <i class="fas fa-calendar-alt"></i> Start Date
                    </label>
                    <input type="date" class="form-control" ng-model="startDate" placeholder="Select start date">
                </div>
            </div>
            <div class="col-xs-12 col-sm-6 col-lg-5">
                <div class="form-group">
                    <label class="control-label">
                        <i class="fas fa-calendar-alt"></i> End Date
                    </label>
                    <input type="date" class="form-control" ng-model="endDate" placeholder="Select end date">
                </div>
            </div>
            <div class="col-xs-12 col-lg-2">
                <div class="form-group">
                    <label class="control-label">&nbsp;</label>
                    <div class="btn-group btn-block">
                        <button class="btn btn-primary" ng-click="getAnalytics()">
                            <i class="glyphicon glyphicon-refresh"></i> Apply
                        </button>
                        <button class="btn btn-default" ng-click="resetDateFilter()">
                            <i class="glyphicon glyphicon-repeat"></i> Reset
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </uib-alert>

    <uib-alert type="info" ng-if="startDate && endDate">
        Showing analytics from <strong>{{startDate | date:'MMM d, yyyy'}}</strong> to <strong>{{endDate | date:'MMM d, yyyy'}}</strong>
    </uib-alert>
    <uib-tabset>
        <uib-tab heading="Performance Analytics" select="onTabSelect('performance')" active="true">
            <loading-component is-loading="isPerformanceLoading" loading-text="Loading performance analytics..."></loading-component>

            <div ng-if="!isPerformanceLoading && performanceLoaded">
                <div class="row">
                    <div class="col-xs-12 col-sm-6 col-md-4 col-lg-2" ng-repeat="metric in [
                        { icon: 'fas fa-dollar-sign', title: 'Total Revenue', value: totalRevenue, desc: 'total revenue generated by your cars', panel: 'primary' },
                        { icon: 'fas fa-calendar-alt', title: 'Total no. of bookings', value: numberOfBookings, desc: 'bookings in the selected date range', panel: 'primary' },
                        { icon: 'fas fa-star-half-alt', title: 'Negative Reviews', value: negativeReviewsCount, desc: 'Based on ratings below 3 stars', panel: 'warning' },
                        { icon: 'fas fa-receipt', title: 'Extra Travel Charges', value: totalFineCollected, desc: 'total fine collected by your cars', panel: 'success' },
                        { icon: 'fas fa-receipt', title: 'Total addons revenue', value: totalRevenueByAddons, desc: 'total revenue by your addons', panel: 'success' },
                        { icon: 'fas fa-receipt', title: 'Average bid cost', value: averageBidCostPerRental, desc: 'average bid cost per rental', panel: 'success' }
                    ]">
                        <div class="panel panel-{{metric.panel}}">
                            <div class="panel-heading">
                                <i class="{{metric.icon}}"></i> {{metric.title}}
                            </div>
                            <div class="panel-body text-center">
                                <h3 ng-if="metric.title === 'Total no. of bookings'">{{metric.value }}</h3>
                                <h3 ng-if="metric.title !== 'Total no. of bookings' && metric.title !== 'Negative Reviews'">{{metric.value | currency:'₹':2}}</h3>
                                <h3 ng-if="metric.title === 'Negative Reviews'">{{metric.value}}</h3>
                                <p class="text-success" ng-if="metric.title !== 'Negative Reviews'">
                                    <i class="fas fa-chart-pie"></i> {{metric.desc}}
                                </p>
                                <p ng-if="metric.title === 'Negative Reviews'"><small>{{metric.desc}}</small></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-xs-12 col-md-4" ng-repeat="chart in [
                        { title: 'Most Popular Cars', id: 'myMostPopularCar', chartType: 'bar' },
                        { title: 'Car Categories (Pie)', id: 'carCategoriesPieChart', chartType: 'pie' },
                        { title: 'Car Wise Negative Reviews', id: 'carWiseNegativeReviews', chartType: 'bar' },
                        { title: 'Top 3 Cars by Earnings', id: 'top3CarsWithMostEarning', chartType: 'bar' },
                        { title: 'Revenue Distribution (Pie)', id: 'revenuePieChart', chartType: 'pie' },
                        { title: 'Top City Wise Negative Reviews', id: 'cityWiseNegativeReviews', chartType: 'line' }
                    ]">
                        <div class="panel panel-default">
                            <div class="panel-heading">{{chart.title}}</div>
                            <div class="panel-body">
                                <canvas id="{{chart.id}}" width="400" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </uib-tab>

        <uib-tab heading="Booking Analytics" select="onTabSelect('booking')">
            <loading-component is-loading="isBookingLoading" loading-text="Loading booking analytics..."></loading-component>

            <div ng-if="!isBookingLoading && bookingLoaded">
                <div class="row">
                    <div class="col-xs-12 col-md-4">
                        <div class="panel panel-info">
                            <div class="panel-heading">
                                <i class="fas fa-clock"></i> Average Rental Duration
                            </div>
                            <div class="panel-body text-center">
                                <h3>{{averageRentalDuration.toFixed(2)}} days</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-12 col-md-4">
                        <div class="panel panel-success">
                            <div class="panel-heading">
                                <i class="fas fa-redo"></i> Repeating Customers
                            </div>
                            <div class="panel-body text-center">
                                <h3>{{repeatingCustomersPercentage.toFixed(2)}}%</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-12 col-md-4">
                        <div class="panel panel-success">
                            <div class="panel-heading">
                                <i class="fas fa-dollar-sign"></i> Average Booking Payment
                            </div>
                            <div class="panel-body text-center">
                                <h3>{{averageBookingPayment | currency:'₹':2}}</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-xs-12 col-md-4" ng-repeat="chart in [
                        { title: 'Peak Bidding Hours', id: 'hourlyBiddingHeatmap', chartType: 'line' },
                        { title: 'Monthly Bookings', id: 'numberOfBookingsPerMonth', chartType: 'bar' },
                        { title: 'City-wise Bookings', id: 'cityWiseBooking', chartType: 'bar' },
                        { title: 'Top 3 Customers', id: 'top3CostumersWithMostBookings', chartType: 'bar' },
                        { title: 'Biddings comparison', id: 'myBidsVsOtherSellersAvgBids', chartType: 'line' },
                        { title: 'Earning comparison', id: 'myEarningVsOtherSellersAvgEarnings', chartType: 'line' },
                        { title: 'Addons Distribution (Pie)', id: 'addonsPieChart', chartType: 'pie' },
                    ]">
                        <div class="panel panel-default">
                            <div class="panel-heading">{{chart.title}}</div>
                            <div class="panel-body">
                                <canvas id="{{chart.id}}" width="400" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </uib-tab>
    </uib-tabset>
</div>
