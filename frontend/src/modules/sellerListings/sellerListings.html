<div class="container-fluid bg-gray-lighter" ng-init="init()">

    <div class="row m-b-15">
        <div class="col-md-6">
            <h3 class="m-t-10">
                <span class="glyphicon glyphicon-list-alt text-primary m-r-5"></span> Vehicle Listings
            </h3>
        </div>
        <div class="col-md-6 text-right">
            <div class="btn-group m-t-10">
                <button class="btn btn-primary" ng-click="openAddCarModal()">
                    <span class="glyphicon glyphicon-plus"></span> Add Vehicle
                </button>
                <button class="btn btn-success" ng-click="openAddonsModal()" >
                    <span class="glyphicon glyphicon-cog"></span> Manage One-Time Addons
                </button>
            </div>
            <div class="input-group pull-right m-t-10" style="width: 250px;">
                <input type="text" class="form-control" 
                    placeholder="Search listings..." 
                    ng-model="search.searchQuery"
                    ng-change="searchCars()">
                <span class="input-group-addon">
                    <span class="glyphicon glyphicon-search"></span>
                </span>
            </div>
        </div>
    </div>


    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h4 class="panel-title"><span class="glyphicon glyphicon-filter"></span> Filters</h4>
                </div>
                <div class="panel-body" style="padding: 15px;">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="btn-group btn-group-justified">
                                <div class="btn-group">
                                    <button class="btn btn-default" ng-click="showAll()" ng-class="{'active': activeButton === 'all'}">All</button>
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-default" ng-click="showApproved()" ng-class="{'active': activeButton === 'approved'}">Approved</button>
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-default" ng-click="showRejected()" ng-class="{'active': activeButton === 'rejected'}">Rejected</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-control" ng-model="filters.category" ng-change="filterCars()">
                                <option value="">All Categories</option>
                                <option ng-repeat="cat in categories" value="{{cat.name}}">{{cat.name}}</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-control" ng-model="filters.city" ng-change="filterCars()">
                                <option value="">All Cities</option>
                                <option ng-repeat="cityOption in cities" value="{{cityOption}}">{{cityOption}}</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-control" ng-model="filters.priceRange" ng-change="filterCars()">
                                <option value="">All Prices</option>
                                <option ng-repeat="priceRange in priceRanges" value="{{priceRange }}">{{priceRange }}</option>
                            </select>
                        </div>
                        <div class="col-md-1 text-right">
                            <button class="btn btn-default btn-block" ng-click="reset()" title="Reset Filters">
                                <span class="glyphicon glyphicon-refresh"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="row" ng-show="loading && !userCars.length">
        <div class="col-md-12 text-center">
            <loading-component></loading-component>
        </div>
    </div>


    <div class="row" ng-show="!loading && noListings">
        <div class="col-md-12">
            <div class="alert alert-info">
                <span class="glyphicon glyphicon-info-sign"></span> No listings found
            </div>
        </div>
    </div>
        

    <div class="row" ng-show="!loading">
        <div class="col-lg-3 col-md-4 col-sm-6 m-b-15" ng-repeat="car in userCars">
            <div class="panel" ng-class="{
                'panel-success': car.status === 'approved',
                'panel-warning': car.status === 'pending',
                'panel-danger': car.status === 'rejected'
            }">
                <div class="panel-heading clearfix">
                    <h4 class="panel-title pull-left">{{ car.company }} {{ car.name }}</h4>
                    <span class="label pull-right" ng-class="{
                        'label-success': car.status === 'approved',
                        'label-warning': car.status === 'pending',
                        'label-danger': car.status === 'rejected'
                    }">{{ car.status }}</span>
                </div>
                
                <div class="panel-body p-0">

                    <div class="text-right p-1" style="background-color: #f8f8f8; padding: 5px 10px; border-bottom: 1px solid #eee;">
                        <h4 class="m-0 text-primary">{{ car.price | currency:"₹" }} <small style="color: #777;">/day</small></h4>
                    </div>
                    

                    <div class="thumbnail m-b-0 b-0"  style="cursor: pointer;">
                        <div uib-carousel active="activeSlide" interval="5000" no-wrap="false">
                            <div uib-slide ng-repeat="slide in car.vehicleImages track by $index" index="$index">
                                <img ng-src="{{slide.url}}" class="img-fluid center-block" style="height: 200px; width: 300px;  object-fit: cover; border-radius: 8px;" alt="Car Image">
                            </div>
                        </div>
                    </div>
                    
                    <table class="table table-striped table-condensed m-b-0">
                        <tr>
                            <td><span class="glyphicon glyphicon-tag text-muted"></span> Category</td>
                            <td class="text-right"><strong>{{ car.category }}</strong></td>
                        </tr>
                        <tr>
                            <td><span class="glyphicon glyphicon-map-marker text-muted"></span> City</td>
                            <td class="text-right"><strong>{{ car.city }}</strong></td>
                        </tr>
                        <tr>
                            <td><span class="glyphicon glyphicon-dashboard text-muted"></span> Mileage</td>
                            <td class="text-right"><strong>{{ car.mileage }}</strong></td>
                        </tr>
                        <tr>
                            <td><span class="glyphicon glyphicon-tint text-muted"></span> Fuel</td>
                            <td class="text-right"><strong>{{ car.fuelType }}</strong></td>
                        </tr>
                    </table>
                </div>
                
                <div class="panel-footer text-center">
                    <div class="btn-group">
                        <button class="btn btn-sm btn-warning" ng-click="openPriceModal(car)" title="Edit Price">
                            <span class="glyphicon glyphicon-pencil"></span> Price
                        </button>
                        <button class="btn btn-sm btn-info" ng-if="car.status === 'approved'" ng-click="viewCarBookings(car)" title="View Bookings">
                            <span class="glyphicon glyphicon-list"></span> Bookings
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    

    <div class="text-center m-t-15 m-b-15" ng-show="loading && userCars.length > 0">
        <loading-component is-loading="loading" loading-text="Loading more..."></loading-component>
    </div>
    

    <div class="row" ng-show="pagination.totalItems > 0">
        <div class="col-md-12 text-center">
            <ul uib-pagination
                total-items="pagination.totalItems"
                ng-model="pagination.currentPage"
                max-size="pagination.maxSize"
                class="pagination-sm"
                boundary-links="true"
                force-ellipses="true"
                items-per-page="pagination.itemsPerPage"
                ng-change="pageChanged()"
                first-text="&laquo;"
                last-text="&raquo;"
                previous-text="&lsaquo;"
                next-text="&rsaquo;"
                direction-links="true">
            </ul>
            <p class="text-muted small">Page {{pagination.currentPage}} of {{pagination.totalPages}}</p>
        </div>
    </div>
    

    <script type="text/ng-template" id="priceModal.html">
        <div class="modal-header">
            <button type="button" class="close" ng-click="$dismiss()">&times;</button>
            <h4 class="modal-title">Update Car Price</h4>
        </div>
        <div class="modal-body">
            <form class="form-horizontal">
                <div class="form-group">
                    <label for="newPrice" class="col-sm-4 control-label">New Daily Rate (₹)</label>
                    <div class="col-sm-8">
                        <input type="number" id="newPrice" class="form-control" placeholder="Enter new price" ng-model="selectedCarPrice.price">
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-default" ng-click="$dismiss()">Cancel</button>
            <button class="btn btn-primary" ng-click="updatePrice()">Save Changes</button>
        </div>
    </script>
    
    <script type="text/ng-template" id="addonsModal.html">
        <div class="modal-header">
            <button type="button" class="close" ng-click="cancel()" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            <h3 class="modal-title">Manage One-time Addons</h3>
        </div>
        <div class="modal-body">
            <uib-tabset active="activeTab">
                <uib-tab index="0" heading="Current Addons">
                    <div style="margin-top: 15px;">
                        <div class="table-responsive" ng-if="addons && addons.length > 0">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Price</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr ng-repeat="addon in addons">
                                        <td>{{addon.name}}</td>
                                        <td>₹{{addon.price}}</td>
                                        <td>
                                            <button class="btn btn-danger btn-sm" ng-click="removeAddon(addon._id)">
                                                <span class="glyphicon glyphicon-trash"></span>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <p ng-if="!addons || addons.length === 0" class="text-muted" style="padding: 15px 0; font-style: italic;">
                            <span class="glyphicon glyphicon-info-sign"></span> No addons added for this car yet.
                        </p>
                    </div>
                </uib-tab>
                
                <uib-tab index="1" heading="Add New Addon">
                    <div style="margin-top: 15px;">
                        <div class="panel panel-default">
                            <div class="panel-body">
                                <form name="addonForm" ng-submit="addAddon()" novalidate>
                                    <div class="form-group" ng-class="{'has-error': addonForm.addonName.$touched && addonForm.addonName.$invalid}">
                                        <label for="addonName">Name *</label>
                                        <input type="text" 
                                            class="form-control" 
                                            id="addonName" 
                                            name="addonName"
                                            ng-model="newAddon.name" 
                                            ng-minlength="3"
                                            ng-maxlength="50"
                                            required>
                                    </div>
                                
                                    <div class="form-group" ng-class="{'has-error': addonForm.addonPrice.$touched && addonForm.addonPrice.$invalid}">
                                        <label for="addonPrice">Price</label>
                                        <input type="number" 
                                            class="form-control" 
                                            id="addonPrice" 
                                            name="addonPrice"
                                            ng-model="newAddon.price" 
                                            ng-min="0" 
                                            step="0.01" 
                                            ng-max="100000"
                                            placeholder="Enter price between 0 and 100000"
                                            required>
                                    </div>
                                    <button type="submit" 
                                            class="btn btn-primary" 
                                            ng-disabled="addonForm.$invalid || isLoading">
                                        <span class="glyphicon glyphicon-plus"></span> Add Addon
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </uib-tab>
            </uib-tabset>
        </div>
        <div class="modal-footer">
            <button class="btn btn-default" ng-click="cancel()">Close</button>
        </div>
    </script>
</div>


<style>
.bg-gray-lighter { background-color: #f9f9f9; }
.m-0 { margin: 0 !important; }
.m-t-5 { margin-top: 5px !important; }
.m-t-10 { margin-top: 10px !important; }
.m-t-15 { margin-top: 15px !important; }
.m-r-5 { margin-right: 5px !important; }
.m-b-0 { margin-bottom: 0 !important; }
.m-b-15 { margin-bottom: 15px !important; }
.p-0 { padding: 0 !important; }
.b-0 { border: 0 !important; }
.text-white { color: white !important; }
</style>

