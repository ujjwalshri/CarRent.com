<loading-component 
    is-loading="isLoading"
    loading-text="Loading Analytics...">
</loading-component>
<back-button></back-button>
<div class="container-fluid" ng-init="init()" ng-class="{'blur-content': isLoading}">
    <div class="page-header">
        <h1><i class="fas fa-chart-line"></i> Seller Analytics Dashboard</h1>
    </div>

    <uib-alert type="info" class="mb-3">
        <div class="row">
            <div class="col-md-5">
                <div class="form-group">
                    <label class="control-label">
                        <i class="fas fa-calendar-alt"></i> Start Date
                    </label>
                    <input type="date" 
                           class="form-control" 
                           ng-model="startDate"
                           placeholder="Select start date">
                </div>
            </div>
            <div class="col-md-5">
                <div class="form-group">
                    <label class="control-label"> 
                        <i class="fas fa-calendar-alt"></i> End Date
                    </label>
                    <input type="date" 
                           class="form-control" 
                           ng-model="endDate" 
                           placeholder="Select end date">
                </div>
            </div>
            <div class="col-md-2">
                <div class="form-group">
                    <label class="control-label">&nbsp;</label>
                    <div class="btn-group btn-block">
                        <button class="btn btn-primary" ng-click="getAnalytics()">
                            <i class="glyphicon glyphicon-refresh"></i> Apply
                        </button>
                        <button class="btn btn-default" ng-click="resetDateFilter()">
                            <i class="glyphicon glyphicon-repeat"></i> Reset
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </uib-alert>
    <uib-alert type="info" ng-if="startDate && endDate">
        Showing analytics from <strong>{{startDate | date:'MMM d, yyyy'}}</strong> to <strong>{{endDate | date:'MMM d, yyyy'}}</strong>
    </uib-alert>
    
    <uib-tabset>
        <uib-tab heading="Performance Analytics" select="onTabSelect('performance')" active="true">
            <div ng-if="isPerformanceLoading" class="text-center p-5">
                <i class="fas fa-spinner fa-spin fa-3x"></i>
                <p class="mt-3">Loading performance analytics...</p>
            </div>

            <div ng-if="!isPerformanceLoading && performanceLoaded">
                <div class="row">
                    <div class="col-md-2">
                        <div class="panel panel-primary">
                            <div class="panel-heading">
                                <i class="fas fa-dollar-sign"></i> Total Revenue
                            </div>
                            <div class="panel-body text-center">
                                <h3>${{totalRevenue | number:2}}</h3>
                                <p class="text-success">
                                    <i class="fas fa-chart-pie"></i> total revenue generated by your cars
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="panel panel-primary">
                            <div class="panel-heading">
                                <i class="fas fa-calendar-alt"></i> Total no. of bookings
                            </div>
                            <div class="panel-body text-center">
                                <h3>{{numberOfBookings}}</h3>
                                <p class="text-success">
                                    <i class="fas fa-chart-pie"></i> bookings in the selected date range
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="panel panel-warning">
                            <div class="panel-heading">
                                <i class="fas fa-star-half-alt"></i> Negative Reviews
                            </div>
                            <div class="panel-body text-center">
                                <h3>{{negativeReviewsCount}}</h3>
                                <p><small>Based on ratings below 3 stars</small></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="panel panel-success">
                            <div class="panel-heading">
                                <i class="fas fa-receipt"></i> Extra Travel Charges
                            </div>
                            <div class="panel-body text-center">
                                <h3>${{totalFineCollected | number:2}}</h3>
                                <p>total fine collected by your cars</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="panel panel-success">
                            <div class="panel-heading">
                                <i class="fas fa-receipt"></i> Total addons revenue
                            </div>
                            <div class="panel-body text-center">
                                <h3>${{totalRevenueByAddons | number:2}}</h3>
                                <p>total revenue by your addons</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="panel panel-success">
                            <div class="panel-heading">
                                <i class="fas fa-receipt"></i> Average bid cost 
                            </div>
                            <div class="panel-body text-center">
                                <h3>${{averageBidCostPerRental | number:2}}</h3>
                                <p>average bid cost per rental</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="panel panel-default">
                            <div class="panel-heading">Car Categories Distribution</div>
                            <div class="panel-body">
                                <canvas id="carCategoriesChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="panel panel-default">
                            <div class="panel-heading">Most Popular Cars</div>
                            <div class="panel-body">
                                <canvas id="myMostPopularCar"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="panel panel-default">
                            <div class="panel-heading">Car Wise Negative Reviews</div>
                            <div class="panel-body">
                                <canvas id="carWiseNegativeReviews"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="panel panel-default">
                            <div class="panel-heading">Top 3 Cars by Earnings</div>
                            <div class="panel-body">
                                <canvas id="top3CarsWithMostEarning"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </uib-tab>

        <uib-tab heading="Booking Analytics" select="onTabSelect('booking')">
            <div ng-if="isBookingLoading" class="text-center p-5">
                <i class="fas fa-spinner fa-spin fa-3x"></i>
                <p class="mt-3">Loading booking analytics...</p>
            </div>

            <div ng-if="!isBookingLoading && bookingLoaded">
                <div class="row">
                    <div class="col-md-4">
                        <div class="panel panel-info">
                            <div class="panel-heading">
                                <i class="fas fa-clock"></i> Average Rental Duration
                            </div>
                            <div class="panel-body text-center">
                                <h3>{{averageRentalDuration.toFixed(2)}} days</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="panel panel-success">
                            <div class="panel-heading">
                                <i class="fas fa-redo"></i> Repeating Customers
                            </div>
                            <div class="panel-body text-center">
                                <h3>{{repeatingCustomersPercentage.toFixed(2)}}%</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="panel panel-success">
                            <div class="panel-heading">
                                <i class="fas fa-dollar-sign"></i> Average Booking Payment
                            </div>
                            <div class="panel-body text-center">
                                <h3>${{averageBookingPayment | number:2}}</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="panel panel-default">
                            <div class="panel-heading">Peak Bidding Hours</div>
                            <div class="panel-body">
                                <canvas id="hourlyBiddingHeatmap"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="panel panel-default">
                            <div class="panel-heading">Monthly Bookings</div>
                            <div class="panel-body">
                                <canvas id="numberOfBookingsPerMonth"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="panel panel-default">
                            <div class="panel-heading">Top 3 Customers</div>
                            <div class="panel-body">
                                <canvas id="top3CostumersWithMostBookings"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="panel panel-default">
                            <div class="panel-heading">Biddings comparison</div>
                            <div class="panel-body">
                                <canvas id="myBidsVsOtherSellersAvgBids"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="panel panel-default">
                            <div class="panel-heading">Earning comparison</div>
                            <div class="panel-body">
                                <canvas id="myEarningVsOtherSellersAvgEarnings"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="panel panel-default">
                            <div class="panel-heading">Selected Addons Count</div>
                            <div class="panel-body">
                                <canvas id="selectedAddonsCount"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </uib-tab>
    </uib-tabset>
</div>
